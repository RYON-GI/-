<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—”ë“œí•„ë“œ ê¸°ì§ˆ ìŠ¤ìºë„ˆ & íŒŒë° ê°€ì´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4db8ff; --bg: #121212; --panel: #1e1e1e; --gold: #ffcc00; --purple: #a335ee; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-container { display: flex; gap: 5px; width: 100%; max-width: 1000px; margin-bottom: -1px; }
        .tab { padding: 10px 25px; background: #2a2a2a; border: 1px solid #333; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; color: #888; transition: 0.2s; }
        .tab.active { background: var(--panel); color: var(--primary); border-top: 3px solid var(--primary); z-index: 2; }
        
        .main-wrapper { display: grid; grid-template-columns: 450px 1fr; gap: 20px; max-width: 1000px; width: 100%; background: var(--panel); padding: 20px; border-radius: 0 12px 12px 12px; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        
        /* ê³µí†µ ì˜ì—­ ì œì–´ */
        .content-area { display: none; grid-column: span 2; }
        .content-area.active { display: flex; flex-direction: column; gap: 20px; }
        .scanner-layout { display: none; grid-template-columns: 450px 1fr; gap: 20px; grid-column: span 2; }
        .scanner-layout.active { display: grid; }

        /* ì„¤ëª…ì„œ ìŠ¤íƒ€ì¼ */
        .guide-step { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid #444; }
        .guide-title { color: var(--gold); font-size: 1.2em; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .guide-img { width: 100%; border-radius: 8px; border: 1px solid #555; margin-top: 15px; }

        /* íŒŒë° ê°€ì´ë“œ ìŠ¤íƒ€ì¼ */
        .farming-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .weapon-selector { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; max-height: 800px; overflow-y: auto; }
        .weapon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-bottom: 20px; }
        .weapon-card { cursor: pointer; border: 2px solid transparent; border-radius: 8px; overflow: hidden; background: #2a2a2a; transition: 0.2s; }
        .weapon-card.selected { border-color: var(--gold); box-shadow: 0 0 10px rgba(255,204,0,0.4); }
        .weapon-card img { width: 100%; height: 80px; object-fit: cover; display: block; }
        .weapon-card div { font-size: 0.7em; padding: 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .recommend-panel { background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 10px; padding: 15px; }
        .place-card { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #444; }
        .place-card.top { border-left-color: var(--gold); background: #2d2a20; }

        /* ìŠ¤ìºë„ˆ ìŠ¤íƒ€ì¼ */
        .control-bar { grid-column: span 2; display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 8px; }
        canvas { border: 2px solid #444; border-radius: 10px; width: 100%; background: #000; }
        .opt-box { background: #252525; padding: 12px 18px; border-radius: 8px; border-left: 5px solid var(--primary); height: 35px; display: flex; align-items: center; margin-top: 5px; }
        .opt-name { font-size: 1.2em; font-weight: bold; color: #ffff00; }
        .section-box { background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 10px; padding: 15px; min-height: 250px; }
        .weapon-item { background: #2a2a2a; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; }
        .match-count { font-size: 0.85em; font-weight: bold; padding: 2px 10px; border-radius: 10px; background: var(--gold); color: #000; }
        .match-count.full { background: #ff4d4d; color: #fff; }
        
        button { padding: 10px 30px; cursor: pointer; font-weight: bold; background: #007bff; color: white; border: none; border-radius: 8px; transition: 0.2s; }
        button:hover { background: #0056b3; }
        .filter-group { display: flex; gap: 15px; font-size: 0.85em; color: #aaa; }
    </style>
</head>
<body>

<div class="tab-container">
    <div id="tab-guide" class="tab active" onclick="switchTab('guide')">ì‚¬ìš© ì„¤ëª…ì„œ</div>
    <div id="tab-farming" class="tab" onclick="switchTab('farming')">ì¶”ì²œ íŒŒë°ì§€</div>
    <div id="tab-warehouse" class="tab" onclick="switchTab('warehouse')">ê·€ì¤‘í’ˆ ì°½ê³ </div>
    <div id="tab-etching" class="tab" onclick="switchTab('etching')">ê¸°ì§ˆ ì‹ê°</div>
</div>

<div class="main-wrapper">
    <div id="area-guide" class="content-area active">
        <div style="text-align: center; margin-bottom: 10px;">
            <h1 style="color: var(--primary); margin-bottom: 5px;">Endfield ê¸°ì§ˆ ìŠ¤ìºë„ˆ ê°€ì´ë“œ</h1>
            <p style="color: #888;">ì •í™•í•œ ì¸ì‹ì„ ìœ„í•´ ì•„ë˜ ê°€ì´ë“œì— ë§ì¶° ê²Œì„ í™”ë©´ì„ ê³µìœ í•´ ì£¼ì„¸ìš”.</p>
        </div>

        <div class="guide-step">
            <div class="guide-title"><span>1ï¸âƒ£</span> í™”ë©´ ê³µìœ  ì„¤ì •</div>
            <div>[í™”ë©´ ê³µìœ  ì‹œì‘] í´ë¦­ í›„ <b>'ì°½' íƒ­</b>ì—ì„œ <b>Endfield ê²Œì„ ì°½</b>ì„ ì„ íƒí•˜ì„¸ìš”. 'ì „ì²´ í™”ë©´'ë³´ë‹¤ 'ì°½' ì„ íƒì´ ì¸ì‹ì´ ë” ì •í™•í•©ë‹ˆë‹¤.</div>
            <img src="1.jpg" class="guide-img" alt="Step 1">
        </div>

        <div class="guide-step">
            <div class="guide-title"><span>2ï¸âƒ£</span> ê·€ì¤‘í’ˆ ì°½ê³  ëª¨ë“œ</div>
            <div>ê°€ë°©ì˜ [ê·€ì¤‘í’ˆ ì°½ê³ ] ë©”ë‰´ì—ì„œ ê¸°ì§ˆì„ í´ë¦­í•œ í™”ë©´ì…ë‹ˆë‹¤. ìš°ì¸¡ì˜ ì¶”ê°€ ìŠ¤í‚¬ 3ì¢…ì„ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</div>
            <img src="2.jpg" class="guide-img" alt="Step 2">
        </div>

        <div class="guide-step">
            <div class="guide-title"><span>3ï¸âƒ£</span> ê¸°ì§ˆ ì‹ê° ëª¨ë“œ</div>
            <div>[ê¸°ì§ˆ ì‹ê°] ë©”ë‰´ì—ì„œ ê¸°ì§ˆì„ ì¥ì°©/ê°•í™”í•  ë•Œì˜ í™”ë©´ì…ë‹ˆë‹¤. í•˜ë‹¨ì˜ ì˜µì…˜ ì˜ì—­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì½ì–´ëƒ…ë‹ˆë‹¤.</div>
            <img src="3.jpg" class="guide-img" alt="Step 3">
        </div>

        <button onclick="switchTab('farming')" style="width: 100%; padding: 20px; font-size: 1.2em; background: var(--primary);">ì„¤ëª…ì„œë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì‹œì‘í•˜ê¸°!</button>
    </div>

    <div id="area-farming" class="content-area">
        <div class="farming-layout">
            <div class="weapon-selector">
                <h3 style="color:var(--gold); margin-top:0;">6ì„± ë¬´ê¸°</h3>
                <div id="grid-6star" class="weapon-grid"></div>
                <h3 style="color:var(--purple)">5ì„± ë¬´ê¸°</h3>
                <div id="grid-5star" class="weapon-grid"></div>
            </div>
            <div class="recommend-panel">
                <h3 style="margin-top:0; border-bottom:1px solid #444; padding-bottom:10px;">ğŸ’¡ ì¶”ì²œ íŒŒë°ì§€</h3>
                <div id="farming-results">ë¬´ê¸° ì‚¬ì§„ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.</div>
            </div>
        </div>
    </div>

    <div id="scanner-area" class="scanner-layout">
        <div class="control-bar">
            <button id="start-btn" disabled>ì—”ì§„ ë¡œë”© ì¤‘...</button>
            <div class="filter-group">
                <label><input type="checkbox" id="check-5star"> 5ì„± í‘œì‹œ</label>
                <label><input type="checkbox" id="include-2match"> 2ê°œ ì¼ì¹˜ í¬í•¨</label>
            </div>
        </div>
        <div class="scan-side">
            <div style="color:var(--primary); font-weight: bold;">ë¶„ì„ í™”ë©´ (Real-time)</div>
            <canvas id="view-canvas"></canvas>
            <div class="opt-container">
                <div class="opt-box"><div id="opt-1" class="opt-name">-</div></div>
                <div class="opt-box"><div id="opt-2" class="opt-name">-</div></div>
                <div class="opt-box"><div id="opt-3" class="opt-name">-</div></div>
            </div>
        </div>
        <div class="result-side">
            <div class="section-box">
                <div style="color:var(--gold); font-weight:bold; border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:5px;">6ì„± ë¬´ê¸° ë§¤ì¹­</div>
                <div id="list-6star"></div>
            </div>
            <div id="section-5star" class="section-box" style="display: none; margin-top:10px;">
                <div style="color:var(--purple); font-weight:bold; border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:5px;">5ì„± ë¬´ê¸° ë§¤ì¹­</div>
                <div id="list-5star"></div>
            </div>
        </div>
    </div>
</div>

<script>
// --- ë°ì´í„°ë² ì´ìŠ¤ ---
const PLACES = [
    { name: "ê±°ì  ì§€ì—­", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ê³µê²©ë ¥","ì—´ê¸°í”¼í•´","ì „ê¸°í”¼í•´","ëƒ‰ê¸°í”¼í•´","ìì—°í”¼í•´","ì•„ì¸ ê°•ë„","ê¶ê·¹ê¸°íšë“íš¨ìœ¨","ì•„ì¸ í”¼í•´","ê°•ê³µ","ì–µì œ","ì¶”ê²©","ë¶„ì‡„","ê¸°ì˜ˆ","ë°©ì¶œ","íë¦„","íš¨ìœ¨"] },
    { name: "ì˜¤ë¦¬ì§€ëŠ„ ì—°êµ¬ êµ¬ì—­", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ê³µê²©ë ¥","ë¬¼ë¦¬í”¼í•´","ì „ê¸°í”¼í•´","ëƒ‰ê¸°í”¼í•´","ìì—°í”¼í•´","ì¹˜ëª…íƒ€í™•ë¥ ","ê¶ê·¹ê¸°íšë“íš¨ìœ¨","ì•„ì¸ í”¼í•´","ì–µì œ","ì¶”ê²©","ì‚¬ê¸°","ê¸°ì˜ˆ","ê³ í†µ","ì˜ë£Œ","ê³¨ì ˆ","íš¨ìœ¨"] },
    { name: "ê´‘ë§¥ êµ¬ì—­", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ìƒëª…ë ¥","ë¬¼ë¦¬í”¼í•´","ì—´ê¸°í”¼í•´","ëƒ‰ê¸°í”¼í•´","ìì—°í”¼í•´","ì¹˜ëª…íƒ€í™•ë¥ ","ì•„ì¸ ê°•ë„","ì¹˜ìœ íš¨ìœ¨","ê°•ê³µ","ì–µì œ","ê¸°ì˜ˆ","ì”í˜¹","ê³ í†µ","ë°©ì¶œ","ì–´ë‘ ","íš¨ìœ¨"] },
    { name: "ì—ë„ˆì§€ ê³µê¸‰ ê³ ì§€", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ê³µê²©ë ¥","ìƒëª…ë ¥","ë¬¼ë¦¬í”¼í•´","ì—´ê¸°í”¼í•´","ìì—°í”¼í•´","ì¹˜ëª…íƒ€í™•ë¥ ","ì•„ì¸ ê°•ë„","ì¹˜ìœ íš¨ìœ¨","ì¶”ê²©","ë¶„ì‡„","ì‚¬ê¸°","ì”í˜¹","ê³ í†µ","ì˜ë£Œ","ê³¨ì ˆ","íë¦„"] },
    { name: "ë¬´ë¦‰ì„±", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ê³µê²©ë ¥","ìƒëª…ë ¥","ì „ê¸°í”¼í•´","ëƒ‰ê¸°í”¼í•´","ì¹˜ëª…íƒ€í™•ë¥ ","ê¶ê·¹ê¸°íšë“íš¨ìœ¨","ì•„ì¸ í”¼í•´","ì¹˜ìœ íš¨ìœ¨","ê°•ê³µ","ë¶„ì‡„","ì”í˜¹","ì˜ë£Œ","ê³¨ì ˆ","ë°©ì¶œ","ì–´ë‘ ","íë¦„"] }
];

const WEAPONS_6 = [
  { name: "ê³¼ê±°ì˜ ì¼í’ˆ", opts: ["ì˜ì§€", "ìƒëª…ë ¥", "íš¨ìœ¨"] },
  { name: "ê¸°ì‚¬ë„ ì •ì‹ ", opts: ["ì˜ì§€", "ìƒëª…ë ¥", "ì˜ë£Œ"] },
  { name: "ëì—†ëŠ” ë°©ë‘", opts: ["ì˜ì§€", "ê³µê²©ë ¥", "íë¦„"] },
  { name: "ë§ê°", opts: ["ì§€ëŠ¥", "ì•„ì¸ í”¼í•´", "ì–´ë‘ "] },
  { name: "ëª¨ë²”", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ê³µê²©ë ¥", "ì–µì œ"] },
  { name: "ë°”ë‹¤ì™€ ë³„ì˜ ê¿ˆ", opts: ["ì§€ëŠ¥", "ì¹˜ìœ íš¨ìœ¨", "ê³ í†µ"] },
  { name: "ë°±ì•¼ì˜ ë³„", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì•„ì¸ ê°•ë„", "ê³ í†µ"] },
  { name: "ë¶€ìš”", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì¹˜ëª…íƒ€í™•ë¥ ", "ì–´ë‘ "] },
  { name: "ë¶„ì‡„ì˜ êµ°ì£¼", opts: ["í˜", "ì¹˜ëª…íƒ€í™•ë¥ ", "ë¶„ì‡„"] },
  { name: "ì‚¬ëª…ì˜ ê¸¸", opts: ["ì˜ì§€", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ì¶”ê²©"] },
  { name: "ì‚°ì˜ ì§€ë°°ì", opts: ["ë¯¼ì²©", "ë¬¼ë¦¬í”¼í•´", "íš¨ìœ¨"] },
  { name: "ìê¸°", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì¹˜ëª…íƒ€í™•ë¥ ", "ê³ í†µ"] },
  { name: "ì•”í‘ì˜ íšƒë¶ˆ", opts: ["ì§€ëŠ¥", "ì—´ê¸°í”¼í•´", "ê³ í†µ"] },
  { name: "ì˜ˆìˆ ì˜ í­êµ°", opts: ["ì§€ëŠ¥", "ì¹˜ëª…íƒ€í™•ë¥ ", "ê³¨ì ˆ"] },
  { name: "ìš©ì‚¬", opts: ["ë¯¼ì²©", "ë¬¼ë¦¬í”¼í•´", "ê¸°ì˜ˆ"] },
  { name: "ìš©ì¡°ì˜ ë¶ˆê½ƒ", opts: ["ì§€ëŠ¥", "ê³µê²©ë ¥", "ì–´ë‘ "] },
  { name: "ìœ„ëŒ€í•œ ì´ë¦„", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ë¬¼ë¦¬í”¼í•´", "ì”í˜¹"] },
  { name: "ì‘í’ˆ: ì¹¨ì‹ í”ì ", opts: ["ì˜ì§€", "ìì—°í”¼í•´", "ì–µì œ"] },
  { name: "ì¥ëŒ€í•œ ì—¼ì›", opts: ["ë¯¼ì²©", "ê³µê²©ë ¥", "ê³ í†µ"] },
  { name: "ì²œë‘¥ì˜ í”ì ", opts: ["í˜", "ìƒëª…ë ¥", "ì˜ë£Œ"] },
  { name: "í´ë˜ë‹ˆë²Œ", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì•„ì¸ ê°•ë„", "ê³ í†µ"] },
  { name: "í…Œë¥´ë°‹ ì»¤í„°", opts: ["ì˜ì§€", "ê³µê²©ë ¥", "íë¦„"] },
  { name: "í­ë°œ ìœ ë‹›", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì•„ì¸ ê°•ë„", "ë°©ì¶œ"] },
  { name: "í•­ë¡œì˜ ê°œì²™ì", opts: ["ì§€ëŠ¥", "ëƒ‰ê¸°í”¼í•´", "ê³ í†µ"] },
  { name: "í—¤ë¼íœê±°", opts: ["í˜", "ê³µê²©ë ¥", "ë°©ì¶œ"] },
  { name: "J.E.T.", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ê³µê²©ë ¥", "ì–µì œ"] }
];

const WEAPONS_5 = [
  { name: "ê°•ì² ì˜ ì—¬ìš´", opts: ["ë¯¼ì²©", "ë¬¼ë¦¬í”¼í•´", "ê¸°ì˜ˆ"] },
  { name: "ê²€ì€ ì¶”ì ì", opts: ["í˜", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ë°©ì¶œ"] },
  { name: "ê³ ëŒ€ì˜ ê°•ì¤„ê¸°", opts: ["í˜", "ì•„ì¸ ê°•ë„", "ì”í˜¹"] },
  { name: "ë¦°ìˆ˜ë¥¼ ì°¾ì•„ì„œ 3.0", opts: ["í˜", "ëƒ‰ê¸°í”¼í•´", "ì–µì œ"] },
  { name: "ë§ìì˜ ë…¸ë˜", opts: ["ì§€ëŠ¥", "ê³µê²©ë ¥", "ì–´ë‘ "] },
  { name: "ë¬´ê°€ë‚´í•˜", opts: ["ì˜ì§€", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ì‚¬ê¸°"] },
  { name: "ë¶ˆì‚¬ì˜ ì„±ì£¼", opts: ["ì§€ëŠ¥", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ì‚¬ê¸°"] },
  { name: "ì„ êµì˜ ììœ ", opts: ["ì˜ì§€", "ì¹˜ìœ íš¨ìœ¨", "ì˜ë£Œ"] },
  { name: "ìˆ­ë°°ì˜ ì‹œì„ ", opts: ["ë¯¼ì²©", "ë¬¼ë¦¬í”¼í•´", "ì–´ë‘ "] },
  { name: "ì‹­ì´ë¬¸", opts: ["ë¯¼ì²©", "ê³µê²©ë ¥", "ê³ í†µ"] },
  { name: "ì´ì„±ì ì¸ ì‘ë³„", opts: ["í˜", "ì—´ê¸°í”¼í•´", "ì¶”ê²©"] },
  { name: "ì‘í’ˆ: ì¤‘ìƒ", opts: ["ë¯¼ì²©", "ì•„ì¸ ê°•ë„", "ê³ í†µ"] },
  { name: "ì¤‘ì‹¬ë ¥", opts: ["ì˜ì§€", "ì „ê¸°í”¼í•´", "ì–µì œ"] },
  { name: "ìµœí›„ì˜ ë©”ì•„ë¦¬", opts: ["í˜", "ìƒëª…ë ¥", "ì˜ë£Œ"] },
  { name: "í‚¤ë©”ë¼ì˜ ì •ì˜", opts: ["í˜", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ì”í˜¹"] },
  { name: "í™©ë¬´ì§€ì˜ ë°©ë‘ì", opts: ["ì§€ëŠ¥", "ì „ê¸°í”¼í•´", "ê³ í†µ"] },
  { name: "O.B.J. ë²¨ë¡œì‹œíˆ¬ìŠ¤", opts: ["ë¯¼ì²©", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ë°©ì¶œ"] },
  { name: "O.B.J. ìŠ¤íŒŒì´í¬", opts: ["ì˜ì§€", "ë¬¼ë¦¬í”¼í•´", "ê³ í†µ"] },
  { name: "O.B.J. ì•„ì¸  ì•„ì´ë´í‹°í‹°", opts: ["ì§€ëŠ¥", "ì•„ì¸ ê°•ë„", "ì¶”ê²©"] },
  { name: "O.B.J. ì—£ì§€ ì˜¤ë¸Œ ë¼ì´íŠ¸", opts: ["ë¯¼ì²©", "ê³µê²©ë ¥", "íë¦„"] },
  { name: "O.B.J. í—¤ë¹„ ë²„ë“ ", opts: ["í˜", "ìƒëª…ë ¥", "íš¨ìœ¨"] }
];

// --- ì„¤ì • ë° ë³€ìˆ˜ ---
let currentTab = 'guide';
let isRunning = false;
let worker = null;
let lastRecognizedOptions = ["-", "-", "-"]; 
let selectedWeapons = new Set();

const video = document.createElement('video');
const viewCanvas = document.getElementById('view-canvas'), viewCtx = viewCanvas.getContext('2d');
const hiddenCanvas = document.createElement('canvas'), hiddenCtx = hiddenCanvas.getContext('2d');

const CONFIGS = {
    warehouse: {
        roi: { x: 0.765, y: 0.332, w: 0.132, h: 0.154 },
        boxes: [ { x: 0.15, y: -0.01, w: 0.81, h: 0.18 }, { x: 0.15, y: 0.32, w: 0.81, h: 0.18 }, { x: 0.15, y: 0.66, w: 0.81, h: 0.18 } ]
    },
    etching: {
        roi: { x: 0.096, y: 0.5, w: 0.14, h: 0.1 },
        boxes: [ { x: 0.02, y: 0.0, w: 0.9, h: 0.25 }, { x: 0.02, y: 0.37, w: 0.9, h: 0.25 }, { x: 0.02, y: 0.72, w: 0.9, h: 0.25 } ]
    }
};

// --- OCR ë³´ì • ---
function normalize(text) {
    let clean = text.replace(/\s+/g, "").replace(/[^\uAC00-\uD7A3]/g, ""); 
    if (!clean) return null;
    clean = clean.replace(/(ì¤‘ê°œ|ì¦ê°€|ì¦˜ê°€|ìŠ¹ê°€|ì¦ˆê¸°|ì¦|ê°€|ë ¥|ê³„|ê¸°|í„±|ë•)$/, "");
    if (/ì–´[ëˆ”ë‘ ë¡¬ë†ˆë”ë£¸ë£¸ë‹ˆã„´ã…]|[ì–´ì—„ì›€]/.test(clean)) { if (clean.includes("ì–´") || clean === "ì—„" || clean === "ì›€") return "ì–´ë‘ "; }
    if (/ê·¸ë£¹|ê·¸ë£°|ê·¸ì˜µ|ê·¸ë£¨|ìœ¼ë£¨|^ë£¨$|íì„|í˜ì¤‘ê°œ|^í˜$/.test(clean)) return "í˜";
    if (/ê³ [ì¶©í†µí‰íŠ¹í† ]|[ê³ êµ¬]í†µ/.test(clean)) return "ê³ í†µ";
    if (/ì§€.ëŠ¥|ì‹œ.ëŠ¥|ì§€ëŠ¥|ì‹œëŠ¥/.test(clean)) return "ì§€ëŠ¥";
    if (/ê¶.ê¸°|íš.íš¨|ê¶ê·¹/.test(clean)) return "ê¶ê·¹ê¸°íšë“íš¨ìœ¨"; 
    if (/ì¹˜.íš¨|ì‹œ.íš¨|ì¹˜ìœ /.test(clean)) return "ì¹˜ìœ íš¨ìœ¨";
    if (/ëŠ¥.ì¹˜|ì£¼.ìš”/.test(clean)) return "ì£¼ìš”ëŠ¥ë ¥ì¹˜";
    if (/ì¹˜.íƒ€|ëª….íƒ€|í™•.ë¥ /.test(clean)) return "ì¹˜ëª…íƒ€í™•ë¥ ";
    if (/ì•„.ì¸ |ì•„.ì¸¡/.test(clean)) return clean.includes("í”¼") ? "ì•„ì¸ í”¼í•´" : "ì•„ì¸ ê°•ë„";
    if (/ë¬¼.ë¦¬|ë¬¼.í”¼/.test(clean)) return "ë¬¼ë¦¬í”¼í•´";
    if (/ëƒ‰.ê¸°/.test(clean)) return "ëƒ‰ê¸°í”¼í•´";
    if (/ì—´.ê¸°/.test(clean)) return "ì—´ê¸°í”¼í•´";
    if (/ì „.ê¸°/.test(clean)) return "ì „ê¸°í”¼í•´";
    if (/ì.ì—°/.test(clean)) return "ìì—°í”¼í•´";
    if (clean.includes("ë¯¼ì²©")) return "ë¯¼ì²©";
    if (clean.includes("ì˜ì§€")) return "ì˜ì§€";
    if (/ê³µê²©|ê²©í„±|ê²©ë•|^ê³µê²©$/.test(clean) || clean === "ê²©") return "ê³µê²©ë ¥";
    if (clean.includes("ìƒëª…")) return "ìƒëª…ë ¥";
    if (clean.includes("íë¦„")) return "íë¦„";
    const etc = ["ì–µì œ","ì”í˜¹","ë°©ì¶œ","ì¶”ê²©","ê¸°ì˜ˆ","ê³¨ì ˆ","ë¶„ì‡„","ì‚¬ê¸°","ì˜ë£Œ","íš¨ìœ¨"];
    for(let k of etc) { if(clean.includes(k)) return k; }
    return clean;
}

// --- OCR ë£¨í”„ ---
async function recognizeLoop() {
    if (!isRunning || (currentTab !== 'warehouse' && currentTab !== 'etching')) return;
    const config = CONFIGS[currentTab];
    if (video.readyState >= 2) {
        const vw = video.videoWidth, vh = video.videoHeight;
        const sx = vw * config.roi.x, sy = vh * config.roi.y, sw = vw * config.roi.w, sh = vh * config.roi.h;
        viewCanvas.width = sw; viewCanvas.height = sh;
        viewCtx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);
        hiddenCanvas.width = sw * 2; hiddenCanvas.height = sh * 2;
        hiddenCtx.filter = 'contrast(170%) grayscale(100%)';
        hiddenCtx.drawImage(video, sx, sy, sw, sh, 0, 0, sw * 2, sh * 2);

        const currentOptions = [];
        for (let i = 0; i < 3; i++) {
            const box = config.boxes[i];
            const res = await worker.recognize(hiddenCanvas, { 
                rectangle: { left: box.x * hiddenCanvas.width, top: box.y * hiddenCanvas.height, width: box.w * hiddenCanvas.width, height: box.h * hiddenCanvas.height } 
            });
            const norm = normalize(res.data.text.trim());
            if (norm) {
                lastRecognizedOptions[i] = norm;
                document.getElementById(`opt-${i+1}`).textContent = norm;
            }
            currentOptions.push(lastRecognizedOptions[i]);
        }
        updateMatches(currentOptions);
    }
    requestAnimationFrame(recognizeLoop);
}

// --- ë§¤ì¹­ ì—…ë°ì´íŠ¸ ---
function updateMatches(currentOptions) {
    const list6 = document.getElementById('list-6star'), list5 = document.getElementById('list-5star');
    const show5 = document.getElementById('check-5star').checked;
    const minMatch = document.getElementById('include-2match').checked ? 2 : 3;
    list6.innerHTML = ""; list5.innerHTML = "";
    document.getElementById('section-5star').style.display = show5 ? 'block' : 'none';
    const matchFn = (db) => db.map(w => ({ weapon: w, count: w.opts.filter(o => currentOptions.includes(o)).length }))
                            .filter(m => m.count >= minMatch).sort((a,b) => b.count - a.count);
    matchFn(WEAPONS_6).forEach(m => {
        const div = document.createElement('div'); div.className = 'weapon-item';
        div.innerHTML = `<span>${m.weapon.name}</span><span class="match-count ${m.count===3?'full':''}">${m.count}ê°œ ì¼ì¹˜</span>`;
        list6.appendChild(div);
    });
    if (show5) {
        matchFn(WEAPONS_5).forEach(m => {
            const div = document.createElement('div'); div.className = 'weapon-item';
            div.innerHTML = `<span>${m.weapon.name}</span><span class="match-count ${m.count===3?'full':''}">${m.count}ê°œ ì¼ì¹˜</span>`;
            list5.appendChild(div);
        });
    }
}

// --- íŒŒë° ê°€ì´ë“œ ë¡œì§ (ìŠ¤í‚¬ ì†ì„± ìš°ì„  + ë¹ˆë„ìˆ˜ ê°€ì¤‘ì¹˜ ì ìš©) ---
function updateFarmingResults() {
    const resDiv = document.getElementById('farming-results');
    if (selectedWeapons.size === 0) { resDiv.innerHTML = "ë¬´ê¸° ì‚¬ì§„ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”."; return; }

    // ì†ì„± ë¶„ë¥˜ ì •ì˜
    const baseStats = ["ë¯¼ì²©", "í˜", "ì˜ì§€", "ì§€ëŠ¥", "ì£¼ìš”ëŠ¥ë ¥ì¹˜"];
    const skillStats = ["ê°•ê³µ", "ì–µì œ", "ì¶”ê²©", "ë¶„ì‡„", "ê¸°ì˜ˆ", "ë°©ì¶œ", "íë¦„", "íš¨ìœ¨", "ì‚¬ê¸°", "ê³ í†µ", "ì˜ë£Œ", "ê³¨ì ˆ", "ì”í˜¹", "ì–´ë‘ "];

    const optionCounts = {};
    selectedWeapons.forEach(w => {
        w.opts.forEach(o => { optionCounts[o] = (optionCounts[o] || 0) + 1; });
    });

    const sortedNeeded = Object.entries(optionCounts)
        .sort((a, b) => b[1] - a[1])
        .map(([name, count]) => {
            const displayCount = count > 1 ? `<span style="color:var(--gold); font-weight:bold;">x${count}</span>` : '';
            return `<span style="background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; margin:2px; display:inline-block;">${name}${displayCount}</span>`;
        });

    const results = PLACES.map(place => {
        const placeOpts = new Set(place.opts);
        const fullyMatchedWeapons = [];
        selectedWeapons.forEach(weapon => {
            if (weapon.opts.every(opt => placeOpts.has(opt))) fullyMatchedWeapons.push(weapon.name);
        });

        // 1. ê¸°ì´ˆ ì˜µì…˜ 3ê°œ (í•„ìš” ë¹ˆë„ ë†’ì€ ìˆœ)
        const recommendedBases = place.opts
            .filter(o => baseStats.includes(o) && optionCounts[o])
            .sort((a, b) => optionCounts[b] - optionCounts[a]).slice(0, 3);

       // 2. ì¶”ê°€/ìŠ¤í‚¬ ì˜µì…˜ ê²°ì • ë¡œì§ (ë¬´ì¡°ê±´ ê²¹ì¹˜ëŠ” ê°¯ìˆ˜ ìš°ì„ )
        const extraAndSkills = place.opts
            .filter(o => !baseStats.includes(o) && optionCounts[o])
            .sort((a, b) => {
                const countA = optionCounts[a];
                const countB = optionCounts[b];
                
                // 1ìˆœìœ„: ë¬´ì¡°ê±´ ê²¹ì¹˜ëŠ” ê°¯ìˆ˜(Count)ê°€ ë§ì€ ìª½
                if (countB !== countA) {
                    return countB - countA;
                }
                
                // 2ìˆœìœ„: ê²¹ì¹˜ëŠ” ê°¯ìˆ˜ê°€ ê°™ë‹¤ë©´ ìŠ¤í‚¬ ì†ì„±ì„ ìš°ì„ 
                const skillStats = ["ê°•ê³µ", "ì–µì œ", "ì¶”ê²©", "ë¶„ì‡„", "ê¸°ì˜ˆ", "ë°©ì¶œ", "íë¦„", "íš¨ìœ¨", "ì‚¬ê¸°", "ê³ í†µ", "ì˜ë£Œ", "ê³¨ì ˆ", "ì”í˜¹", "ì–´ë‘ "];
                const isSkillA = skillStats.includes(a);
                const isSkillB = skillStats.includes(b);
                return isSkillB - isSkillA;
            });

        const recommendedExtra = extraAndSkills.slice(0, 1);

        return { name: place.name, fullyMatchedWeapons, recommendedBases, recommendedExtra, matchCount: fullyMatchedWeapons.length };
    }).sort((a, b) => b.matchCount - a.matchCount || b.recommendedExtra.length - a.recommendedExtra.length);

    let html = `
        <div style="margin-bottom:15px; padding:12px; background:rgba(0,0,0,0.4); border-radius:8px; border:1px solid #444;">
            <div style="color:var(--primary); font-size:0.8em; font-weight:bold; margin-bottom:8px;">ğŸ“Š í†µí•© ëª©í‘œ ì˜µì…˜ (ìš°ì„ ìˆœìœ„ìˆœ)</div>
            <div style="line-height:1.8;">${sortedNeeded.join(' ')}</div>
        </div>`;

    results.forEach((res, i) => {
        const weaponList = res.fullyMatchedWeapons.length > 0 
            ? `<div style="color:var(--gold); font-size:0.85em; margin-top:5px;">ğŸ¯ íŒŒë° ëŒ€ìƒ: ${res.fullyMatchedWeapons.join(', ')}</div>`
            : `<div style="color:#777; font-size:0.85em; margin-top:5px;">ì í•©í•œ ë¬´ê¸° ì—†ìŒ</div>`;

        html += `
            <div class="place-card ${i === 0 && res.matchCount > 0 ? 'top' : ''}">
                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:8px;">
                    <span>${i === 0 && res.matchCount > 0 ? 'ğŸ‘‘ ' : ''}${res.name}</span>
                    <span style="color:var(--gold)">${res.matchCount}ê°œ ë¬´ê¸° ì¢…ê²° ê°€ëŠ¥</span>
                </div>
                <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:6px; font-size:0.85em;">
                    <div style="margin-bottom:8px; padding-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <strong>âœ… ì¶”ì²œ ì„¸íŒ…:</strong> ${[...res.recommendedBases, ...res.recommendedExtra].join(', ') || 'ì—†ìŒ'}
                    </div>
                    ${weaponList}
                </div>
            </div>`;
    });
    resDiv.innerHTML = html;
}

function initFarmingUI() {
    const g6 = document.getElementById('grid-6star'), g5 = document.getElementById('grid-5star');
    const createCard = (w, path) => {
        const div = document.createElement('div'); div.className = 'weapon-card';
        const safeFileName = w.name.replace(/:/g, ""); 
        div.onclick = () => {
            if(selectedWeapons.has(w)) { selectedWeapons.delete(w); div.classList.remove('selected'); }
            else { selectedWeapons.add(w); div.classList.add('selected'); }
            updateFarmingResults();
        };
        div.innerHTML = `<img src="${path}/${safeFileName}.png" onerror="this.src='https://via.placeholder.com/75?text=No+Img'"><div>${w.name}</div>`;
        return div;
    };
    WEAPONS_6.forEach(w => g6.appendChild(createCard(w, '6ì„± ë¬´ê¸°')));
    WEAPONS_5.forEach(w => g5.appendChild(createCard(w, '5ì„± ë¬´ê¸°')));
}

// --- ì¸í„°í˜ì´ìŠ¤ ì œì–´ ---
function switchTab(tabId) {
    currentTab = tabId;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab-${tabId}`).classList.add('active');
    document.getElementById('area-guide').classList.remove('active');
    document.getElementById('area-farming').classList.remove('active');
    document.getElementById('scanner-area').classList.remove('active');

    if (tabId === 'guide') {
        document.getElementById('area-guide').classList.add('active');
    } else if (tabId === 'farming') {
        document.getElementById('area-farming').classList.add('active');
    } else {
        document.getElementById('scanner-area').classList.add('active');
        if (isRunning) recognizeLoop();
    }
}
    // ë¬´ê¸° ì´ë¦„ì— : í¬í•¨ë˜ëŠ”ê±° ì œê±° ë²„ì „
function initFarmingUI() {
    const g6 = document.getElementById('grid-6star'), g5 = document.getElementById('grid-5star');
    
    const createCard = (w, path) => {
        const div = document.createElement('div'); 
        div.className = 'weapon-card';
        
        // íŒŒì¼ëª…ì—ì„œ ì½œë¡ (:)ê³¼ ê³µë°±ì„ ì œê±°í•˜ê±°ë‚˜ ì¹˜í™˜í•˜ì—¬ ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±
        // ì˜ˆ: "ì‘í’ˆ: ì¤‘ìƒ" -> "ì‘í’ˆ ì¤‘ìƒ" (ì½œë¡ ë§Œ ì‚­ì œ)
        const safeFileName = w.name.replace(/:/g, ""); 
        
        div.onclick = () => {
            if(selectedWeapons.has(w)) { 
                selectedWeapons.delete(w); 
                div.classList.remove('selected'); 
            } else { 
                selectedWeapons.add(w); 
                div.classList.add('selected'); 
            }
            updateFarmingResults();
        };

        // ì‹¤ì œ íŒŒì¼ì€ 'ì‘í’ˆ ì¤‘ìƒ.png' ë“±ìœ¼ë¡œ ì €ì¥ë˜ì–´ ìˆì–´ì•¼ í•¨
        div.innerHTML = `
            <img src="${path}/${safeFileName}.png" onerror="this.src='https://via.placeholder.com/75?text=No+Img'">
            <div>${w.name}</div>
        `;
        return div;
    };

    WEAPONS_6.forEach(w => g6.appendChild(createCard(w, '6ì„± ë¬´ê¸°')));
    WEAPONS_5.forEach(w => g5.appendChild(createCard(w, '5ì„± ë¬´ê¸°')));
}
    
// --- ì´ˆê¸°í™” ---
async function init() {
    initFarmingUI();
    try {
        worker = await Tesseract.createWorker('kor');
        await worker.setParameters({ tessedit_pageseg_mode: '7' });
        document.getElementById('start-btn').disabled = false;
        document.getElementById('start-btn').textContent = "í™”ë©´ ê³µìœ  ì‹œì‘";
    } catch (e) { alert("OCR ë¡œë”© ì‹¤íŒ¨"); }
}

document.getElementById('start-btn').onclick = async () => {
    try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" } });
        video.srcObject = stream;
        video.onloadedmetadata = () => { video.play(); isRunning = true; recognizeLoop(); };
    } catch (e) { alert("ê³µìœ  ì·¨ì†Œ ë˜ëŠ” ì˜¤ë¥˜"); }
};

init();
</script>
</body>
</html>
