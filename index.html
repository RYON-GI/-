<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—”ë“œí•„ë“œ ê¸°ì§ˆ ìŠ¤ìºë„ˆ & íŒŒë° ê°€ì´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4db8ff; --bg: #121212; --panel: #1e1e1e; --gold: #ffcc00; --purple: #a335ee; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        /* ë©”ì¸ íƒ­ */
        .tab-container { display: flex; gap: 5px; width: 100%; max-width: 1100px; margin-bottom: -1px; }
        .tab { padding: 12px 25px; background: #2a2a2a; border: 1px solid #333; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; color: #888; transition: 0.2s; }
        .tab.active { background: var(--panel); color: var(--primary); border-top: 3px solid var(--primary); z-index: 2; }
        
        .main-wrapper { display: flex; flex-direction: column; gap: 20px; max-width: 1100px; width: 100%; background: var(--panel); padding: 25px; border-radius: 0 12px 12px 12px; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.6); min-height: 700px; }
        
        .content-area { display: none; }
        .content-area.active { display: block; }

        /* ì„œë¸Œ íƒ­ */
        .sub-tab-bar { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .sub-tab { padding: 8px 18px; background: #333; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: 0.2s; color: #aaa; }
        .sub-tab.active { background: var(--primary); color: #000; font-weight: bold; }

        /* ì§€ì—­ë³„/ë¬´ê¸°ë³„ ë ˆì´ì•„ì›ƒ */
        .area-grid-layout, .weapon-farming-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        .region-select-box { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .region-btn { padding: 10px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; cursor: pointer; color: #ccc; flex: 1; text-align: center; min-width: 120px; }
        .region-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(77, 184, 255, 0.1); }
        
        .option-filter-group { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .opt-btn-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .opt-select-btn { padding: 6px 12px; background: #333; border: 1px solid #444; border-radius: 4px; font-size: 0.85em; cursor: pointer; }
        .opt-select-btn.active { background: var(--gold); color: #000; border-color: var(--gold); }

        .weapon-scroll-area { max-height: 800px; overflow-y: auto; padding-right: 10px; }
        .weapon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 30px; }
        .weapon-card { cursor: pointer; border: 1px solid #333; border-radius: 6px; background: #252525; transition: 0.2s; padding: 5px; text-align: center; }
        .weapon-card img { width: 100%; height: auto; border-radius: 4px; filter: brightness(0.7); }
        .weapon-card.selected { border-color: var(--gold); background: #2d2a20; }
        .weapon-card.selected img { filter: brightness(1); }

        .report-panel { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 20px; border: 1px solid #333; }
        .target-opt-box { background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .opt-tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .opt-tag { padding: 4px 10px; background: #3d3d3d; border-radius: 4px; font-size: 0.85em; color: #ddd; border: 1px solid #444; }

        /* ìŠ¤ìºë„ˆ */
        .scanner-main-layout { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
        .control-bar { display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; gap: 20px; }
        #view-canvas { border: 2px solid #444; border-radius: 10px; width: 100%; background: #000; }
        .opt-box { background: #252525; padding: 10px; border-radius: 8px; border-left: 5px solid var(--primary); margin-top: 8px; }
        .opt-name { font-size: 1.1em; font-weight: bold; color: #ffff00; }
        .section-box { background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 10px; padding: 15px; min-height: 200px; margin-bottom: 10px; }

        button { padding: 10px 20px; cursor: pointer; font-weight: bold; background: #007bff; color: white; border: none; border-radius: 8px; }
        .filter-group { display: flex; gap: 15px; font-size: 0.9em; color: #aaa; }

        /* ê²°ê³¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ê³µìš©) */
        .result-region-card { display: flex; align-items: center; gap: 12px; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid transparent; }
        .result-region-card.best { border-color: rgba(255, 204, 0, 0.4); background: rgba(255, 204, 0, 0.05); }
    </style>
</head>
<body>

<div class="tab-container">
    <div id="tab-guide" class="tab active" onclick="switchTab('guide')">ì‚¬ìš© ì„¤ëª…ì„œ</div>
    <div id="tab-farming" class="tab" onclick="switchTab('farming')">ì¶”ì²œ íŒŒë°ì§€</div>
    <div id="tab-search" class="tab" onclick="switchTab('search')">ê¸°ì§ˆ ê²€ìƒ‰</div>
</div>

<div class="main-wrapper">
    <div id="area-guide" class="content-area active">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: var(--primary); font-size: 2em; margin-bottom: 10px;">Endfield ê¸°ì§ˆ ìŠ¤ìºë„ˆ ê°€ì´ë“œ</h2>
            <p style="color: #aaa;">ì •í™•í•œ ì¸ì‹ì„ ìœ„í•´ ì•„ë˜ ê°€ì´ë“œì— ë§ì¶° ê²Œì„ í™”ë©´ì„ ê³µìœ í•´ ì£¼ì„¸ìš”.</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px; border: 1px solid #333;">
                <h3 style="color: var(--primary); margin-top: 0; margin-bottom: 15px;">
                    <span style="background: var(--primary); color: #000; padding: 2px 10px; border-radius: 4px; margin-right: 8px;">1</span>í™”ë©´ ê³µìœ  ì„¤ì •
                </h3>
                <p style="font-size: 0.95em; line-height: 1.6; color: #ccc; margin-bottom: 20px; min-height: 50px;">
                    <strong>[ê¸°ì§ˆ ê²€ìƒ‰]</strong> íƒ­ì—ì„œ <strong>[í™”ë©´ ê³µìœ  ì‹œì‘]</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.<br>
                    íŒì—…ì°½ì˜ <strong>'ì°½'</strong> íƒ­ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ <strong>Endfield</strong> ê²Œì„ í™”ë©´ì„ ì„ íƒí•´ì•¼ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.
                </p>
                <div style="width: 100%; border-radius: 8px; border: 1px solid #444; overflow: hidden; background: #000;">
                    <img src="1.jpg" alt="í™”ë©´ ê³µìœ  ê°€ì´ë“œ" style="width: 100%; height: auto; display: block;">
                </div>
            </div>

            <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px; border: 1px solid #333;">
                <h3 style="color: var(--gold); margin-top: 0; margin-bottom: 15px;">
                    <span style="background: var(--gold); color: #000; padding: 2px 10px; border-radius: 4px; margin-right: 8px;">2</span>ì¸ì‹ ëª¨ë“œ (ì°½ê³  / ì‹ê°)
                </h3>
                <p style="font-size: 0.95em; line-height: 1.6; color: #ccc; margin-bottom: 20px; min-height: 50px;">
                    <strong>ê·€ì¤‘í’ˆ ì°½ê³ </strong> ë˜ëŠ” <strong>ê¸°ì§ˆ ì‹ê°</strong> í™”ë©´ì„ ë„ìš°ë©´ ìë™ìœ¼ë¡œ ì˜µì…˜ì„ ë¶„ì„í•©ë‹ˆë‹¤.<br>
                    ìƒí™©ì— ë§ëŠ” ëª¨ë“œ(ì„œë¸Œ íƒ­)ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.
                </p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="width: 100%; border-radius: 8px; border: 1px solid #444; overflow: hidden; background: #000;">
                        <img src="2.jpg" alt="ì°½ê³  UI ê°€ì´ë“œ" style="width: 100%; height: auto; display: block;">
                    </div>
                    <div style="width: 100%; border-radius: 8px; border: 1px solid #444; overflow: hidden; background: #000;">
                        <img src="3.jpg" alt="ì‹ê° UI ê°€ì´ë“œ" style="width: 100%; height: auto; display: block;">
                    </div>
                </div>
            </div>
        </div>

        <div style="background: rgba(77, 184, 255, 0.1); padding: 18px 25px; border-radius: 10px; border-left: 5px solid var(--primary); margin-bottom: 30px;">
            <strong style="color: var(--primary); font-size: 1.1em;">ğŸ’¡ ì‹ ê·œ ê¸°ëŠ¥: ì§€ì—­ë³„ ì°¾ê¸°</strong>
            <p style="margin: 8px 0 0 0; font-size: 1em; color: #bbb; line-height: 1.5;">
                <strong>[ì¶”ì²œ íŒŒë°ì§€]</strong> íƒ­ì—ì„œ ì§€ì—­ì„ ì„ íƒí•˜ê³  ì›í•˜ëŠ” ì˜µì…˜ì„ ì¡°í•©í•´ ë³´ì„¸ìš”. í•´ë‹¹ ì§€ì—­ì—ì„œ ìœ íš¨í•œ ë¬´ê¸°ë“¤ì„ ì¦‰ì‹œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
            </p>
        </div>

        <button onclick="switchTab('farming')" style="width: 100%; padding: 22px; font-size: 1.3em; background: var(--primary); color: #000; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(77, 184, 255, 0.3);">
            ë¶„ì„ ì‹œì‘í•˜ê¸° (íŒŒë°ì§€ ì¶”ì²œ)
        </button>
    </div>

    <div id="area-farming" class="content-area">
        <div class="sub-tab-bar">
            <div id="sub-tab-region" class="sub-tab active" onclick="switchSubTab('farming', 'region')">ì§€ì—­ë³„ íŒŒë°ì§€</div>
            <div id="sub-tab-weapon" class="sub-tab" onclick="switchSubTab('farming', 'weapon')">ë¬´ê¸°ë³„ íŒŒë°ì§€</div>
        </div>

        <div id="sub-content-region" class="sub-content">
            <div class="area-grid-layout">
                <div>
                    <div class="region-select-box" id="region-btns"></div>
                    <div id="region-option-area" style="display:none;"></div>
                </div>
                <div class="report-panel">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">ğŸ“‹ ì§€ì—­ íŒŒë° ë¦¬í¬íŠ¸</h3>
                        <button onclick="resetRegionFilters()" style="padding:4px 10px; font-size:0.8em; background:#444;">ì´ˆê¸°í™”</button>
                    </div>
                    <div id="region-results">ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
                </div>
            </div>
        </div>

        <div id="sub-content-weapon" class="sub-content" style="display:none;">
            <div class="weapon-farming-layout">
                <div class="weapon-scroll-area">
                    <h3 style="color:var(--gold); border-bottom: 1px solid #333; padding-bottom: 8px;">6ì„± ë¬´ê¸°</h3>
                    <div id="grid-6star" class="weapon-grid"></div>
                    <h3 style="color:var(--purple); border-bottom: 1px solid #333; padding-bottom: 8px;">5ì„± ë¬´ê¸°</h3>
                    <div id="grid-5star" class="weapon-grid"></div>
                </div>
                <div class="report-panel">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">ğŸ’¡ ì¶”ì²œ íŒŒë°ì§€</h3>
                        <button onclick="resetWeaponSelection()" style="padding:4px 10px; font-size:0.8em; background:#444;">ì´ˆê¸°í™”</button>
                    </div>
                    <div class="target-opt-box">
                        <div style="font-size:0.9em; font-weight:bold; color:#aaa;">ğŸ“Š í†µí•© ëª©í‘œ ì˜µì…˜</div>
                        <div id="total-target-opts" class="opt-tag-container">
                            <span style="color:#666; font-size:0.85em;">ë¬´ê¸°ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</span>
                        </div>
                    </div>
                    <div id="farming-results-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="area-search" class="content-area">
        <div class="sub-tab-bar">
            <div id="sub-tab-warehouse" class="sub-tab active" onclick="switchSubTab('search', 'warehouse')">ê·€ì¤‘í’ˆ ì°½ê³ </div>
            <div id="sub-tab-etching" class="sub-tab" onclick="switchSubTab('search', 'etching')">ê¸°ì§ˆ ì‹ê°</div>
        </div>

        <div class="control-bar">
            <div id="btn-wrapper" style="position: relative; width: 160px; height: 42px;">
                <button id="start-btn" style="position: absolute; width:100%; height:100%;" disabled>ì—”ì§„ ë¡œë”© ì¤‘...</button>
                <button id="stop-btn" style="position: absolute; width:100%; height:100%; display:none; background:#dc3545;">í™”ë©´ ê³µìœ  ì¤‘ì§€</button>
            </div>
            <div class="filter-group">
                <label style="cursor:pointer;"><input type="checkbox" id="check-5star"> 5ì„± í‘œì‹œ</label>
                <label style="cursor:pointer;"><input type="checkbox" id="include-2match"> 2ê°œ ì¼ì¹˜ í¬í•¨</label>
            </div>
        </div>

        <div class="scanner-main-layout">
            <div class="video-panel">
                <div style="margin-bottom:8px; font-weight:bold; color:var(--primary);">ì‹¤ì‹œê°„ ì¸ì‹ í™”ë©´</div>
                <canvas id="view-canvas"></canvas>
                <div id="detected-options">
                    <div class="opt-box"><div id="opt-1" class="opt-name">-</div></div>
                    <div class="opt-box"><div id="opt-2" class="opt-name">-</div></div>
                    <div class="opt-box"><div id="opt-3" class="opt-name">-</div></div>
                </div>
            </div>
            <div class="result-panel">
                <div class="section-box">
                    <div style="color:var(--gold); font-weight:bold; border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:5px;">6ì„± ë¬´ê¸° ë§¤ì¹­</div>
                    <div id="list-6star"></div>
                </div>
                <div id="section-5star" class="section-box" style="display: none;">
                    <div style="color:var(--purple); font-weight:bold; border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:5px;">5ì„± ë¬´ê¸° ë§¤ì¹­</div>
                    <div id="list-5star"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- ë°ì´í„°ë² ì´ìŠ¤ ---
const PLACES = [
    { name: "ê±°ì  ì§€ì—­", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ê³µê²©ë ¥","ì—´ê¸°í”¼í•´","ì „ê¸°í”¼í•´","ëƒ‰ê¸°í”¼í•´","ìì—°í”¼í•´","ì•„ì¸ ê°•ë„","ê¶ê·¹ê¸°íšë“íš¨ìœ¨","ì•„ì¸ í”¼í•´","ê°•ê³µ","ì–µì œ","ì¶”ê²©","ë¶„ì‡„","ê¸°ì˜ˆ","ë°©ì¶œ","íë¦„","íš¨ìœ¨"] },
    { name: "ì˜¤ë¦¬ì§€ëŠ„ ì—°êµ¬ êµ¬ì—­", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ê³µê²©ë ¥","ë¬¼ë¦¬í”¼í•´","ì „ê¸°í”¼í•´","ëƒ‰ê¸°í”¼í•´","ìì—°í”¼í•´","ì¹˜ëª…íƒ€í™•ë¥ ","ê¶ê·¹ê¸°íšë“íš¨ìœ¨","ì•„ì¸ í”¼í•´","ì–µì œ","ì¶”ê²©","ì‚¬ê¸°","ê¸°ì˜ˆ","ê³ í†µ","ì˜ë£Œ","ê³¨ì ˆ","íš¨ìœ¨"] },
    { name: "ê´‘ë§¥ êµ¬ì—­", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ìƒëª…ë ¥","ë¬¼ë¦¬í”¼í•´","ì—´ê¸°í”¼í•´","ëƒ‰ê¸°í”¼í•´","ìì—°í”¼í•´","ì¹˜ëª…íƒ€í™•ë¥ ","ì•„ì¸ ê°•ë„","ì¹˜ìœ íš¨ìœ¨","ê°•ê³µ","ì–µì œ","ê¸°ì˜ˆ","ì”í˜¹","ê³ í†µ","ë°©ì¶œ","ì–´ë‘ ","íš¨ìœ¨"] },
    { name: "ì—ë„ˆì§€ ê³µê¸‰ ê³ ì§€", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ê³µê²©ë ¥","ìƒëª…ë ¥","ë¬¼ë¦¬í”¼í•´","ì—´ê¸°í”¼í•´","ìì—°í”¼í•´","ì¹˜ëª…íƒ€í™•ë¥ ","ì•„ì¸ ê°•ë„","ì¹˜ìœ íš¨ìœ¨","ì¶”ê²©","ë¶„ì‡„","ì‚¬ê¸°","ì”í˜¹","ê³ í†µ","ì˜ë£Œ","ê³¨ì ˆ","íë¦„"] },
    { name: "ë¬´ë¦‰ì„±", opts: ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ê³µê²©ë ¥","ìƒëª…ë ¥","ì „ê¸°í”¼í•´","ëƒ‰ê¸°í”¼í•´","ì¹˜ëª…íƒ€í™•ë¥ ","ê¶ê·¹ê¸°íšë“íš¨ìœ¨","ì•„ì¸ í”¼í•´","ì¹˜ìœ íš¨ìœ¨","ê°•ê³µ","ë¶„ì‡„","ì”í˜¹","ì˜ë£Œ","ê³¨ì ˆ","ë°©ì¶œ","ì–´ë‘ ","íë¦„"] }
];

const PRIMARY_STATS = ["ë¯¼ì²©", "í˜", "ì˜ì§€", "ì§€ëŠ¥", "ì£¼ìš”ëŠ¥ë ¥ì¹˜"];
const EXTRA_STATS = ["ê³µê²©ë ¥", "ìƒëª…ë ¥", "ë¬¼ë¦¬í”¼í•´", "ì—´ê¸°í”¼í•´", "ì „ê¸°í”¼í•´", "ëƒ‰ê¸°í”¼í•´", "ìì—°í”¼í•´", "ì¹˜ëª…íƒ€í™•ë¥ ", "ì•„ì¸ ê°•ë„", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ì•„ì¸ í”¼í•´", "ì¹˜ìœ íš¨ìœ¨"];

const WEAPONS_6 = [
  { name: "ê³¼ê±°ì˜ ì¼í’ˆ", opts: ["ì˜ì§€", "ìƒëª…ë ¥", "íš¨ìœ¨"] }, { name: "ê¸°ì‚¬ë„ ì •ì‹ ", opts: ["ì˜ì§€", "ìƒëª…ë ¥", "ì˜ë£Œ"] },
  { name: "ëì—†ëŠ” ë°©ë‘", opts: ["ì˜ì§€", "ê³µê²©ë ¥", "íë¦„"] }, { name: "ë§ê°", opts: ["ì§€ëŠ¥", "ì•„ì¸ í”¼í•´", "ì–´ë‘ "] },
  { name: "ëª¨ë²”", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ê³µê²©ë ¥", "ì–µì œ"] }, { name: "ë°”ë‹¤ì™€ ë³„ì˜ ê¿ˆ", opts: ["ì§€ëŠ¥", "ì¹˜ìœ íš¨ìœ¨", "ê³ í†µ"] },
  { name: "ë°±ì•¼ì˜ ë³„", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì•„ì¸ ê°•ë„", "ê³ í†µ"] }, { name: "ë¶€ìš”", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì¹˜ëª…íƒ€í™•ë¥ ", "ì–´ë‘ "] },
  { name: "ë¶„ì‡„ì˜ êµ°ì£¼", opts: ["í˜", "ì¹˜ëª…íƒ€í™•ë¥ ", "ë¶„ì‡„"] }, { name: "ì‚¬ëª…ì˜ ê¸¸", opts: ["ì˜ì§€", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ì¶”ê²©"] },
  { name: "ì‚°ì˜ ì§€ë°°ì", opts: ["ë¯¼ì²©", "ë¬¼ë¦¬í”¼í•´", "íš¨ìœ¨"] }, { name: "ìê¸°", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì¹˜ëª…íƒ€í™•ë¥ ", "ê³ í†µ"] },
  { name: "ì•”í‘ì˜ íšƒë¶ˆ", opts: ["ì§€ëŠ¥", "ì—´ê¸°í”¼í•´", "ê³ í†µ"] }, { name: "ì˜ˆìˆ ì˜ í­êµ°", opts: ["ì§€ëŠ¥", "ì¹˜ëª…íƒ€í™•ë¥ ", "ê³¨ì ˆ"] },
  { name: "ìš©ì‚¬", opts: ["ë¯¼ì²©", "ë¬¼ë¦¬í”¼í•´", "ê¸°ì˜ˆ"] }, { name: "ìš©ì¡°ì˜ ë¶ˆê½ƒ", opts: ["ì§€ëŠ¥", "ê³µê²©ë ¥", "ì–´ë‘ "] },
  { name: "ìœ„ëŒ€í•œ ì´ë¦„", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ë¬¼ë¦¬í”¼í•´", "ì”í˜¹"] }, { name: "ì‘í’ˆ: ì¹¨ì‹ í”ì ", opts: ["ì˜ì§€", "ìì—°í”¼í•´", "ì–µì œ"] },
  { name: "ì¥ëŒ€í•œ ì—¼ì›", opts: ["ë¯¼ì²©", "ê³µê²©ë ¥", "ê³ í†µ"] }, { name: "ì²œë‘¥ì˜ í”ì ", opts: ["í˜", "ìƒëª…ë ¥", "ì˜ë£Œ"] },
  { name: "í´ë˜ë‹ˆë²Œ", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì•„ì¸ ê°•ë„", "ê³ í†µ"] }, { name: "í…Œë¥´ë°‹ ì»¤í„°", opts: ["ì˜ì§€", "ê³µê²©ë ¥", "íë¦„"] },
  { name: "í­ë°œ ìœ ë‹›", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ì•„ì¸ ê°•ë„", "ë°©ì¶œ"] }, { name: "í•­ë¡œì˜ ê°œì²™ì", opts: ["ì§€ëŠ¥", "ëƒ‰ê¸°í”¼í•´", "ê³ í†µ"] },
  { name: "í—¤ë¼íœê±°", opts: ["í˜", "ê³µê²©ë ¥", "ë°©ì¶œ"] }, { name: "J.E.T.", opts: ["ì£¼ìš”ëŠ¥ë ¥ì¹˜", "ê³µê²©ë ¥", "ì–µì œ"] }
];

const WEAPONS_5 = [
  { name: "ê°•ì² ì˜ ì—¬ìš´", opts: ["ë¯¼ì²©", "ë¬¼ë¦¬í”¼í•´", "ê¸°ì˜ˆ"] }, { name: "ê²€ì€ ì¶”ì ì", opts: ["í˜", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ë°©ì¶œ"] },
  { name: "ê³ ëŒ€ì˜ ê°•ì¤„ê¸°", opts: ["í˜", "ì•„ì¸ ê°•ë„", "ì”í˜¹"] }, { name: "ë¦°ìˆ˜ë¥¼ ì°¾ì•„ì„œ 3.0", opts: ["í˜", "ëƒ‰ê¸°í”¼í•´", "ì–µì œ"] },
  { name: "ë§ìì˜ ë…¸ë˜", opts: ["ì§€ëŠ¥", "ê³µê²©ë ¥", "ì–´ë‘ "] }, { name: "ë¬´ê°€ë‚´í•˜", opts: ["ì˜ì§€", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ì‚¬ê¸°"] },
  { name: "ë¶ˆì‚¬ì˜ ì„±ì£¼", opts: ["ì§€ëŠ¥", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ì‚¬ê¸°"] }, { name: "ì„ êµì˜ ììœ ", opts: ["ì˜ì§€", "ì¹˜ìœ íš¨ìœ¨", "ì˜ë£Œ"] },
  { name: "ìˆ­ë°°ì˜ ì‹œì„ ", opts: ["ë¯¼ì²©", "ë¬¼ë¦¬í”¼í•´", "ì–´ë‘ "] }, { name: "ì‹­ì´ë¬¸", opts: ["ë¯¼ì²©", "ê³µê²©ë ¥", "ê³ í†µ"] },
  { name: "ì´ì„±ì ì¸ ì‘ë³„", opts: ["í˜", "ì—´ê¸°í”¼í•´", "ì¶”ê²©"] }, { name: "ì‘í’ˆ: ì¤‘ìƒ", opts: ["ë¯¼ì²©", "ì•„ì¸ ê°•ë„", "ê³ í†µ"] },
  { name: "ì¤‘ì‹¬ë ¥", opts: ["ì˜ì§€", "ì „ê¸°í”¼í•´", "ì–µì œ"] }, { name: "ìµœí›„ì˜ ë©”ì•„ë¦¬", opts: ["í˜", "ìƒëª…ë ¥", "ì˜ë£Œ"] },
  { name: "í‚¤ë©”ë¼ì˜ ì •ì˜", opts: ["í˜", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ì”í˜¹"] }, { name: "í™©ë¬´ì§€ì˜ ë°©ë‘ì", opts: ["ì§€ëŠ¥", "ì „ê¸°í”¼í•´", "ê³ í†µ"] },
  { name: "O.B.J. ë²¨ë¡œì‹œíˆ¬ìŠ¤", opts: ["ë¯¼ì²©", "ê¶ê·¹ê¸°íšë“íš¨ìœ¨", "ë°©ì¶œ"] }, { name: "O.B.J. ìŠ¤íŒŒì´í¬", opts: ["ì˜ì§€", "ë¬¼ë¦¬í”¼í•´", "ê³ í†µ"] },
  { name: "O.B.J. ì•„ì¸  ì•„ì´ë´í‹°í‹°", opts: ["ì§€ëŠ¥", "ì•„ì¸ ê°•ë„", "ì¶”ê²©"] }, { name: "O.B.J. ì—£ì§€ ì˜¤ë¸Œ ë¼ì´íŠ¸", opts: ["ë¯¼ì²©", "ê³µê²©ë ¥", "íë¦„"] },
  { name: "O.B.J. í—¤ë¹„ ë²„ë“ ", opts: ["í˜", "ìƒëª…ë ¥", "íš¨ìœ¨"] }
];

// --- ì „ì—­ ë³€ìˆ˜ ---
let isRunning = false;
let worker = null;
let selectedWeapons = new Set();
let selectedRegion = null;
let regionBases = new Set();
let regionExtra = null;
let currentMainTab = 'guide';
let currentSubTabs = { farming: 'region', search: 'warehouse' };

const video = document.createElement('video');
const viewCanvas = document.getElementById('view-canvas'), viewCtx = viewCanvas.getContext('2d');
const hiddenCanvas = document.createElement('canvas'), hiddenCtx = hiddenCanvas.getContext('2d');

const CONFIGS = {
    warehouse: { roi: { x: 0.765, y: 0.332, w: 0.132, h: 0.154 }, boxes: [ { x: 0.15, y: -0.01, w: 0.81, h: 0.18 }, { x: 0.15, y: 0.32, w: 0.81, h: 0.18 }, { x: 0.15, y: 0.66, w: 0.81, h: 0.18 } ] },
    etching: { roi: { x: 0.096, y: 0.5, w: 0.14, h: 0.1 }, boxes: [ { x: 0.02, y: 0.0, w: 0.9, h: 0.25 }, { x: 0.02, y: 0.37, w: 0.9, h: 0.25 }, { x: 0.02, y: 0.72, w: 0.9, h: 0.25 } ] }
};

// --- ì‹œìŠ¤í…œ í•¨ìˆ˜ ---
function switchTab(tabId) {
    currentMainTab = tabId;
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.id === `tab-${tabId}`));
    document.querySelectorAll('.content-area').forEach(a => a.classList.toggle('active', a.id === `area-${tabId}`));
}

function switchSubTab(mainId, subId) {
    currentSubTabs[mainId] = subId;
    const parent = document.getElementById(`area-${mainId}`);
    parent.querySelectorAll('.sub-tab').forEach(t => t.classList.toggle('active', t.id === `sub-tab-${subId}`));
    
    if (mainId === 'farming') {
        document.getElementById('sub-content-region').style.display = subId === 'region' ? 'block' : 'none';
        document.getElementById('sub-content-weapon').style.display = subId === 'weapon' ? 'block' : 'none';
    }
}

// --- ì§€ì—­ë³„ íŒŒë° UI ---
function initRegionUI() {
    const btnBox = document.getElementById('region-btns');
    PLACES.forEach(p => {
        const btn = document.createElement('div');
        btn.className = 'region-btn';
        btn.textContent = p.name;
        btn.onclick = () => selectRegion(p);
        btnBox.appendChild(btn);
    });
}

function selectRegion(place) {
    selectedRegion = place;
    regionBases.clear(); 
    regionExtra = null; 
    document.querySelectorAll('.region-btn').forEach(b => b.classList.toggle('active', b.textContent === place.name));
    
    const optionArea = document.getElementById('region-option-area');
    optionArea.style.display = 'block';
    optionArea.innerHTML = `
        <div class="option-filter-group">
            <div style="font-weight:bold; color:var(--primary);">ê¸°ì´ˆ ì†ì„± (ìµœëŒ€ 3ê°œ)</div>
            <div id="base-opt-grid" class="opt-btn-grid"></div>
        </div>
        <div class="option-filter-group">
            <div style="font-weight:bold; color:var(--gold);">ì‹¬í™” ì†ì„± (ì¶”ê°€/ìŠ¤í‚¬ ì¤‘ íƒ 1)</div>
            <div style="font-size:0.8em; color:#888; margin-top:10px;">â–  ì¶”ê°€ ì†ì„±</div>
            <div id="extra-opt-grid" class="opt-btn-grid"></div>
            <div style="font-size:0.8em; color:#888; margin-top:10px;">â–  ìŠ¤í‚¬ ì†ì„±</div>
            <div id="skill-opt-grid" class="opt-btn-grid"></div>
        </div>
    `;

    const baseGrid = document.getElementById('base-opt-grid');
    const extraGrid = document.getElementById('extra-opt-grid');
    const skillGrid = document.getElementById('skill-opt-grid');

    place.opts.forEach(opt => {
        const btn = document.createElement('div');
        btn.className = 'opt-select-btn';
        btn.textContent = opt;

        if (PRIMARY_STATS.includes(opt)) {
            btn.onclick = () => {
                if (regionBases.has(opt)) regionBases.delete(opt);
                else if (regionBases.size < 3) regionBases.add(opt);
                btn.classList.toggle('active', regionBases.has(opt));
                updateRegionResults();
            };
            baseGrid.appendChild(btn);
        } else {
            btn.onclick = () => {
                regionExtra = (regionExtra === opt) ? null : opt;
                document.querySelectorAll('#extra-opt-grid .opt-select-btn, #skill-opt-grid .opt-select-btn').forEach(b => b.classList.remove('active'));
                if (regionExtra) btn.classList.add('active');
                updateRegionResults();
            };
            if (EXTRA_STATS.includes(opt)) extraGrid.appendChild(btn);
            else skillGrid.appendChild(btn);
        }
    });
    updateRegionResults();
}

function updateRegionResults() {
    const resDiv = document.getElementById('region-results');
    if(!selectedRegion) return;
    
    const filter = [...regionBases];
    if(regionExtra) filter.push(regionExtra);

    const matches = [...WEAPONS_6, ...WEAPONS_5].filter(w => 
        w.opts.every(o => selectedRegion.opts.includes(o)) && w.opts.some(o => filter.includes(o))
    ).map(w => {
        const is6 = WEAPONS_6.some(s => s.name === w.name);
        return { ...w, matchCount: w.opts.filter(o => filter.includes(o)).length, path: is6 ? '6ì„± ë¬´ê¸°' : '5ì„± ë¬´ê¸°', color: is6 ? 'var(--gold)' : 'var(--purple)' };
    }).sort((a,b) => b.matchCount - a.matchCount);

    if(matches.length === 0) { resDiv.innerHTML = "ì¡°ê±´ì— ë§ëŠ” ë¬´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }

    resDiv.innerHTML = matches.map(m => `
        <div class="result-region-card ${m.matchCount === 3 ? 'best' : ''}">
            <img src="${m.path}/${m.name.replace(/:/g,"")}.png" onerror="this.src='https://via.placeholder.com/50?text=IMG'" style="width:50px; height:50px; border-radius:4px;">
            <div style="flex-grow:1;">
                <div style="display:flex; justify-content:space-between;">
                    <strong style="color:${m.color}">${m.name}</strong>
                    <span style="color:var(--gold); font-weight:bold;">${m.matchCount}/3</span>
                </div>
                <div style="font-size:0.8em; color:#888;">${m.opts.join(', ')}</div>
            </div>
        </div>
    `).join('');
}

function resetRegionFilters() {
    if(selectedRegion) selectRegion(selectedRegion);
}

// --- ë¬´ê¸°ë³„ íŒŒë° UI (ë¡œì§ ìˆ˜ì • ë²„ì „) ---
function initFarmingUI() {
    const g6 = document.getElementById('grid-6star'), g5 = document.getElementById('grid-5star');
    const createCard = (w, path) => {
        const div = document.createElement('div');
        div.className = 'weapon-card';
        div.onclick = () => {
            if(selectedWeapons.has(w)) { 
                selectedWeapons.delete(w); 
                div.classList.remove('selected'); 
            } else { 
                selectedWeapons.add(w); 
                div.classList.add('selected'); 
            }
            updateFarmingResults();
        };
        div.innerHTML = `<img src="${path}/${w.name.replace(/:/g,"")}.png" onerror="this.src='https://via.placeholder.com/80?text=No+Img'"><div>${w.name}</div>`;
        return div;
    };
    WEAPONS_6.forEach(w => g6.appendChild(createCard(w, '6ì„± ë¬´ê¸°')));
    WEAPONS_5.forEach(w => g5.appendChild(createCard(w, '5ì„± ë¬´ê¸°')));
}

function updateFarmingResults() {
    const selectedListContainer = document.getElementById('total-target-opts'); // IDëŠ” ìœ ì§€í•˜ë˜ ë‚´ìš©ì€ ë¬´ê¸°ì •ë³´ë¡œ í™œìš©
    const resultContainer = document.getElementById('farming-results-container');
    
    if (selectedWeapons.size === 0) {
        selectedListContainer.innerHTML = `<span style="color:#666; font-size:0.85em;">ë¬´ê¸°ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</span>`;
        resultContainer.innerHTML = `<div style="text-align:center; padding: 40px; color:#666;">ì„ íƒëœ ë¬´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
    }

    // 1. ì„ íƒí•œ ë¬´ê¸° ëª©ë¡ ë° ì˜µì…˜ í‘œì‹œ
    selectedListContainer.innerHTML = Array.from(selectedWeapons).map(w => `
        <div style="background:#333; padding:8px 12px; border-radius:6px; margin-bottom:5px; border-left:3px solid var(--gold);">
            <div style="font-weight:bold; font-size:0.9em; color:var(--gold);">${w.name}</div>
            <div style="font-size:0.8em; color:#bbb;">í•„ìš” ì˜µì…˜: ${w.opts.join(', ')}</div>
        </div>
    `).join('');

    // 2. ì§€ì—­ë³„ ì¶”ì²œ íŒŒë° ì˜µì…˜ ê³„ì‚°
    const results = PLACES.map(p => {
        // ì´ ì§€ì—­ì—ì„œ íŒŒë° ê°€ëŠ¥í•œ(ì˜µì…˜ì´ í¬í•¨ëœ) ì„ íƒ ë¬´ê¸°ë“¤
        const matchedWeapons = Array.from(selectedWeapons).filter(w => 
            w.opts.every(opt => p.opts.includes(opt))
        );

        // í•´ë‹¹ ë¬´ê¸°ë“¤ì„ ìœ„í•´ ì´ ì§€ì—­ì—ì„œ ë…¸ë ¤ì•¼ í•  í•µì‹¬ ì˜µì…˜ë“¤(ì¤‘ë³µ ì œê±°)
        const targetOpts = new Set();
        matchedWeapons.forEach(w => w.opts.forEach(o => targetOpts.add(o)));

        return { 
            name: p.name, 
            matchedCount: matchedWeapons.length,
            recommendOpts: Array.from(targetOpts)
        };
    }).sort((a,b) => b.matchedCount - a.matchedCount);

    // 3. ê²°ê³¼ ë Œë”ë§
    resultContainer.innerHTML = results.map(r => `
        <div class="result-region-card ${r.matchedCount > 0 ? 'best' : ''}" style="flex-direction: column; align-items: flex-start; gap: 8px;">
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                <strong style="font-size:1.1em; color:${r.matchedCount > 0 ? 'var(--primary)' : '#888'}">${r.name}</strong>
                <span style="background:var(--gold); color:#000; padding:2px 8px; border-radius:10px; font-size:0.8em; font-weight:bold;">
                    ${r.matchedCount}ê°œ ë¬´ê¸° íŒŒë° ê°€ëŠ¥
                </span>
            </div>
            <div style="width:100%; background:rgba(0,0,0,0.3); padding:10px; border-radius:6px;">
                <div style="font-size:0.8em; color:var(--gold); margin-bottom:5px; font-weight:bold;">ğŸ¯ ì¶”ì²œ íŒŒë° ì˜µì…˜</div>
                <div style="display:flex; flex-wrap:wrap; gap:5px;">
                    ${r.recommendOpts.length > 0 
                        ? r.recommendOpts.map(opt => `<span style="font-size:0.85em; color:#eee; background:#444; padding:2px 8px; border-radius:4px;">${opt}</span>`).join('')
                        : '<span style="color:#666; font-size:0.85em;">ì¶”ì²œ ì˜µì…˜ ì—†ìŒ</span>'}
                </div>
            </div>
        </div>
    `).join('');
}

function resetWeaponSelection() {
    document.querySelectorAll('.weapon-card').forEach(c => c.classList.remove('selected'));
    selectedWeapons.clear();
    updateFarmingResults();
}

// --- ìŠ¤ìºë„ˆ (OCR) ---
function normalize(text) {
    let clean = text.replace(/\s+/g, "").replace(/[^\uAC00-\uD7A3]/g, "");
    const targets = ["ë¯¼ì²©","í˜","ì˜ì§€","ì§€ëŠ¥","ì£¼ìš”ëŠ¥ë ¥ì¹˜","ê³µê²©ë ¥","ìƒëª…ë ¥","ë¬¼ë¦¬í”¼í•´","ì—´ê¸°í”¼í•´","ì „ê¸°í”¼í•´","ëƒ‰ê¸°í”¼í•´","ìì—°í”¼í•´","ì¹˜ëª…íƒ€í™•ë¥ ","ì•„ì¸ ê°•ë„","ê¶ê·¹ê¸°íšë“íš¨ìœ¨","ì•„ì¸ í”¼í•´","ì¹˜ìœ íš¨ìœ¨","ê°•ê³µ","ì–µì œ","ì¶”ê²©","ë¶„ì‡„","ê¸°ì˜ˆ","ë°©ì¶œ","íë¦„","íš¨ìœ¨","ì‚¬ê¸°","ê³ í†µ","ì˜ë£Œ","ê³¨ì ˆ","ì”í˜¹","ì–´ë‘ "];
    for(let t of targets) { if(clean.includes(t)) return t; }
    return null;
}

async function recognizeLoop() {
    if (!isRunning || currentMainTab !== 'search') return;
    const config = CONFIGS[currentSubTabs.search];
    if (video.readyState >= 2) {
        const vw = video.videoWidth, vh = video.videoHeight;
        const sx = vw * config.roi.x, sy = vh * config.roi.y, sw = vw * config.roi.w, sh = vh * config.roi.h;
        viewCanvas.width = sw; viewCanvas.height = sh;
        viewCtx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);
        
        hiddenCanvas.width = sw * 2; hiddenCanvas.height = sh * 2;
        hiddenCtx.filter = 'contrast(170%) grayscale(100%)';
        hiddenCtx.drawImage(video, sx, sy, sw, sh, 0, 0, sw * 2, sh * 2);

        const found = [];
        for (let i = 0; i < 3; i++) {
            const b = config.boxes[i];
            const res = await worker.recognize(hiddenCanvas, { rectangle: { left: b.x * 2 * sw, top: b.y * 2 * sh, width: b.w * 2 * sw, height: b.h * 2 * sh } });
            const norm = normalize(res.data.text);
            document.getElementById(`opt-${i+1}`).textContent = norm || "-";
            if(norm) found.push(norm);
        }
        updateScannerMatch(found);
    }
    requestAnimationFrame(recognizeLoop);
}

function updateScannerMatch(opts) {
    const show5 = document.getElementById('check-5star').checked;
    const minMatch = document.getElementById('include-2match').checked ? 2 : 3;
    document.getElementById('section-5star').style.display = show5 ? 'block' : 'none';

    const process = (list, targetId) => {
        const matches = list.map(w => ({ name: w.name, count: w.opts.filter(o => opts.includes(o)).length }))
                            .filter(m => m.count >= minMatch).sort((a,b) => b.count - a.count);
        document.getElementById(targetId).innerHTML = matches.map(m => `
            <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #333; font-size:0.9em;">
                <span>${m.name}</span><span style="color:var(--gold)">${m.count}ê°œ ì¼ì¹˜</span>
            </div>
        `).join('');
    };
    process(WEAPONS_6, 'list-6star');
    if(show5) process(WEAPONS_5, 'list-5star');
}

// --- ì´ˆê¸°í™” ---
async function init() {
    initFarmingUI();
    initRegionUI();
    try {
        worker = await Tesseract.createWorker('kor');
        await worker.setParameters({ tessedit_pageseg_mode: '7' });
        document.getElementById('start-btn').disabled = false;
        document.getElementById('start-btn').textContent = "í™”ë©´ ê³µìœ  ì‹œì‘";
    } catch (e) { console.error(e); }
}

document.getElementById('start-btn').onclick = async () => {
    try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        video.srcObject = stream;
        video.onloadedmetadata = () => { 
            video.play(); isRunning = true; recognizeLoop(); 
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'block';
        };
        stream.getVideoTracks()[0].onended = stopSharing;
    } catch (e) { alert("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); }
};

document.getElementById('stop-btn').onclick = stopSharing;

function stopSharing() {
    isRunning = false;
    if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
    document.getElementById('start-btn').style.display = 'block';
    document.getElementById('stop-btn').style.display = 'none';
    document.querySelectorAll('.opt-name').forEach(el => el.textContent = '-');
}

init();
</script>
</body>
</html>

